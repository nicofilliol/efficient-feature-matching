import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns

sp_latencies = {570: 0.4201434850692749, 688: 0.39669487476348875, 471: 0.37252519130706785, 877: 0.3760874032974243, 541: 0.37369260787963865, 958: 0.37560009956359863, 1023: 0.3738440275192261, 1215: 0.36701149940490724, 1110: 0.37718141078948975, 1082: 0.37412199974060056, 804: 0.36986069679260253, 468: 0.3738292932510376, 540: 0.3690120935440063, 1175: 0.3582230806350708, 284: 0.35966479778289795, 638: 0.3707163453102112, 476: 0.36179380416870116, 474: 0.36492161750793456, 988: 0.3694464206695557, 960: 0.35937602519989015, 1463: 0.3654951095581055, 450: 0.361292290687561, 1038: 0.37500839233398436, 1255: 0.3750846147537231, 548: 0.37002360820770264, 1113: 0.36932709217071535, 247: 0.3697213888168335, 358: 0.3670947074890137, 1048: 0.36715087890625, 612: 0.3686680793762207, 294: 0.36513049602508546, 692: 0.3674945831298828, 794: 0.36871559619903566, 1104: 0.3661801338195801, 1442: 0.36708500385284426, 376: 0.3634006977081299, 604: 0.3643930912017822, 727: 0.36915500164031984, 643: 0.36806938648223875, 160: 0.36706540584564207, 668: 0.37200069427490234, 831: 0.3663120985031128, 636: 0.37601656913757325, 1474: 0.3688663005828857, 230: 0.35998446941375734, 908: 0.36005828380584715, 758: 0.35820698738098145, 1196: 0.3650842189788818, 404: 0.3655892848968506, 485: 0.3671106815338135, 686: 0.36615839004516604, 865: 0.36192572116851807, 1162: 0.3649303913116455, 868: 0.36194140911102296, 372: 0.36881728172302247, 1119: 0.3676218748092651, 479: 0.36854469776153564, 1131: 0.3666321039199829, 243: 0.3633146047592163, 420: 0.3689643144607544, 897: 0.3700531005859375, 355: 0.365779185295105, 768: 0.39059009552001955, 1099: 0.3829904079437256, 467: 0.40690340995788576, 995: 0.36122679710388184, 442: 0.3669808149337769, 711: 0.3615544080734253, 1063: 0.35763299465179443, 550: 0.3608195066452026, 899: 0.3637825965881348, 454: 0.37080981731414797, 1092: 0.37617979049682615, 395: 0.3747042894363403, 458: 0.38104231357574464, 600: 0.3937309980392456, 1054: 0.3782987117767334, 703: 0.380433988571167, 737: 0.363683295249939, 1425: 0.3686150312423706, 771: 0.37420310974121096, 390: 0.40837056636810304, 510: 0.3651388883590698, 863: 0.3703202962875366, 751: 0.3709207057952881, 368: 0.37101187705993655, 202: 0.36614601612091063, 424: 0.36610660552978513, 1676: 0.36897141933441163, 881: 0.37041800022125243, 1008: 0.3699310064315796, 432: 0.3719316959381104, 652: 0.3777890205383301, 725: 0.37091567516326907, 577: 0.37245490550994875, 472: 0.37629499435424807, 648: 0.3774592876434326, 640: 0.3737748861312866, 461: 0.3736771821975708}
sg_latencies = {570: 0.10477077960968018, 688: 0.1430974245071411, 471: 0.06793680191040039, 877: 0.16847922801971435, 541: 0.09300727844238281, 958: 0.21709988117218018, 1023: 0.20069189071655275, 1215: 0.26493148803710936, 1110: 0.28139939308166506, 1082: 0.26656618118286135, 804: 0.19549307823181153, 468: 0.08371310234069824, 540: 0.11343259811401367, 1175: 0.291215705871582, 284: 0.04456539154052734, 638: 0.14018068313598633, 476: 0.07736010551452636, 474: 0.07766561508178711, 988: 0.2355910062789917, 960: 0.20313310623168945, 1463: 0.37127811908721925, 450: 0.09552309513092042, 1038: 0.28456459045410154, 1255: 0.2708815813064575, 548: 0.10578258037567138, 1113: 0.26143860816955566, 247: 0.04873769283294678, 358: 0.07443711757659913, 1048: 0.2777151823043823, 612: 0.14572463035583497, 294: 0.04937520027160645, 692: 0.13094899654388428, 794: 0.2683029890060425, 1104: 0.21188440322875976, 1442: 0.5232117176055908, 376: 0.06128571033477783, 604: 0.1377432107925415, 727: 0.18840670585632324, 643: 0.12656421661376954, 160: 0.031424093246459964, 668: 0.12851829528808595, 831: 0.13953781127929688, 636: 0.13808720111846923, 1474: 0.3353625059127808, 230: 0.05006062984466553, 908: 0.244561505317688, 758: 0.15192623138427735, 1196: 0.27934718132019043, 404: 0.059910821914672854, 485: 0.07568042278289795, 686: 0.10883529186248779, 865: 0.1915816068649292, 1162: 0.2549216985702515, 868: 0.2505630970001221, 372: 0.07129380702972413, 1119: 0.28253328800201416, 479: 0.08368639945983887, 1131: 0.290009593963623, 243: 0.04690999984741211, 420: 0.06265950202941895, 897: 0.16074399948120116, 355: 0.07944869995117188, 768: 0.12759990692138673, 1099: 0.29596197605133057, 467: 0.08681249618530273, 995: 0.223776912689209, 442: 0.07338769435882568, 711: 0.16509521007537842, 1063: 0.1993967056274414, 550: 0.10161890983581542, 899: 0.2799025774002075, 454: 0.07205080986022949, 1092: 0.2281186103820801, 395: 0.07484028339385987, 458: 0.09870040416717529, 600: 0.11502952575683593, 1054: 0.28616039752960204, 703: 0.1461920976638794, 737: 0.17294771671295167, 1425: 0.5807924032211303, 771: 0.23273272514343263, 390: 0.09465808868408203, 510: 0.08992607593536377, 863: 0.22726168632507324, 751: 0.13893020153045654, 368: 0.07926170825958252, 202: 0.040439820289611815, 424: 0.06995198726654053, 1676: 0.5505789756774903, 881: 0.24082448482513427, 1008: 0.3094965934753418, 432: 0.08653950691223145, 652: 0.1272416114807129, 725: 0.14692800045013427, 577: 0.10304319858551025, 472: 0.06270701885223388, 648: 0.13359031677246094, 640: 0.1270015001296997, 461: 0.08965580463409424}

sns.set_theme()
sns.set_style(style='white')

n_keypoints = np.fromiter(sp_latencies.keys(), dtype=float)
latencies = np.fromiter(sp_latencies.values(), dtype=float)
bins = np.linspace(0, 2000, 10)
digitized = np.digitize(n_keypoints, bins)
bin_means_sp = np.array([latencies[digitized == i].mean() for i in range(1, len(bins))])
mask = np.isnan(bin_means_sp)
bin_means_sp[mask] = np.interp(np.flatnonzero(mask), np.flatnonzero(~mask), bin_means_sp[~mask])

n_keypoints = np.fromiter(sg_latencies.keys(), dtype=float)
latencies = np.fromiter(sg_latencies.values(), dtype=float)
bin_means_sg = np.array([latencies[digitized == i].mean() for i in range(1, len(bins))])
mask = np.isnan(bin_means_sg)
bin_means_sg[mask] = np.interp(np.flatnonzero(mask), np.flatnonzero(~mask), bin_means_sg[~mask])

bins_x = [(bins[i]+bins[i+1])//2 for i in range(len(bins)-1)]
plt.stackplot(bins_x, [bin_means_sp*1e3, bin_means_sg*1e3], labels=['SuperPoint', 'SuperGlue'], alpha=0.8)
plt.legend(loc='upper left')
plt.ylabel("Time (ms)")
plt.xlabel("Number of keypoints per image")
plt.title("Inference Time of SuperPoint and SuperGlue")
plt.grid(True, alpha=0.3)
plt.show()